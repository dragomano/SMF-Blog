---
title: Заметки об изменениях в SMF 3.0
description: Какие изменения ждут разработчиков модификаций при переходе на SMF 3.0?
date: 2024-03-01
slug: zametki-ob-izmeneniyah-v-smf-30
authors: [bugo]
tags: [разработка, модификации]
categories: [articles]
---

Обзор основных изменений в следующей мажорной версии SMF — _тройке_ (SMF 3).

<!-- more -->

Эта статья в первую очередь для тех, кто так или иначе связан с работой форумов на базе SMF, и установкой/разработкой дополнений к ним.

Здесь мы поговорим об изменениях, которые уже произошли в текущем исходном коде SMF 3.0 и затрагивают работу модификаций.

## Системные требования

Первым самым важным изменением является обновление минимальных требований к установке SMF:

- PHP 8.0
- MySQL 8.0.35 (MariaDB 10.4)
- PostgreSQL 12.17

Так что если вы до сих пор сидите на хостинге с PHP 7 и MySQL 5.7, есть повод задуматься. Если планируете обновляться. Чем дольше вы тянете, тем сложнее (и дороже) это будет сделать потом.

{{ note('[Поддерживаемые версии MySQL/MariaDB](https://docs.cpanel.net/knowledge-base/general-systems-administration/supported-mysql-mariadb-versions/) в cPanel', 'На заметку') }}

## Изменения в `package-info.xml`

Чтобы ваша модификация устанавливалась в SMF 3.0, потребуется обновить номер версии в секциях `install` и `uninstall`:

```xml
  <install for="3.0.*">
    ...
  </install>

  <uninstall for="3.0.*">
    ...
  </uninstall>
```

Вместо звёздочки можно подставить конкретный номер версии. Или просто перечислять все поддерживаемые вашим модом версии через запятую.

## Изменения в коде

Основным нововведением является отказ от глобальных переменных и переход на классы со статическими свойствами.

Все глобальные переменные перенесены в отдельные статические свойства различных утилитарных классов. А многие популярные функции (`loadCSSFile`, `loadTemplate` и т. д.) переехали в статические методы тех же или отдельных классов.

Посмотрите на сравнительную таблицу, в которой я привёл некоторые изменения:

| SMF 2.1.x                   |               SMF 3.0               |
| --------------------------- | :---------------------------------: |
| `$context`                  |          `Utils::$context`          |
| `$smcFunc`                  |          `Utils::$smcFunc`          |
| `$modSettings`              |       `Config::$modSettings`        |
| `$scripturl`                |        `Config::$scripturl`         |
| `$language`                 |         `Config::$language`         |
| `$txt`                      |            `Lang::$txt`             |
| `loadLanguage($lang)`       |         `Lang::load($lang)`         |
| `$settings`                 |     `Theme::$current->settings`     |
| `$options`                  |     `Theme::$current->options`      |
| `loadTemplate($name)`       |    `Theme::loadTemplate($name)`     |
| `loadCSSFile($file)`        |     `Theme::loadCSSFile($file)`     |
| `loadJavaScriptFile($file)` | `Theme::loadJavaScriptFile($file)`  |
| `$user_info`                |            `User::$me`              |
| `parse_bbc($str)`           | `BBCodeParser::load()->parse($str)` |

{{ note('На первый взгляд может показаться, что придётся создавать отдельную версию каждой модификации для SMF 3.0. Однако не всё так плохо. В SMF 3.0 Alpha 1 реализован **режим обратной совместимости**, который позволяет использовать почти весь ваш код без изменений (но есть исключения). Пока он включён (а включён он на данный момент по умолчанию), большинство модификаций SMF 2.1, работающих на хуках, будут совместимы и с 3.0. Нужно будет обновить лишь `package-info.xml` или устанавливать моды в режиме эмуляции SMF 2.1.') }}

{{ tip('Для тех, кто хочет уже сейчас писать код в стиле SMF 3.0, я предлагаю пакет [smf-compat](https://github.com/dragomano/SMF-Compat)') }}

## Исключения, требующие внимания

Однако некоторые вещи всё-таки потребуют от вас определённых действий. Перечислим их.

### Фоновые и запланированные задачи

Если вы использовали в SMF 2.1 для работы с фоновыми задачами стандартный класс `SMF_BackgroundTask`, в 3.0 вместо него нужно использовать `SMF\Tasks\BackgroundTask` (но можно оставить и `SMF_BackgroundTask`, он используется в качестве псевдонима). А для запланированных задач (их можно настраивать через админку) введён дополнительный класс `SMF\Tasks\ScheduledTask`. Подробнее можно почитать в комментариях в файле _Sources/TaskRunner.php_.

### Хуки

Введён новый хук — [integrate_permissions_list](/hooks/integrate-permissions-list) — для более удобного добавления разрешений. Но так как добавлен он только в 3.0, смысла использовать его пока мало. Разве что только в новых модах, предназначенных исключительно для 3.0.

### SSI

Функции SSI перемещены в отдельный класс `SMF\ServerSideIncludes` с соответствующими статическими методами. Например, функция `ssi_topBoards()` в 3.0 теперь вызывается так: `ServerSideIncludes::topBoards()`. Сам файл SSI.php остался в корне форума и его по-прежнему надо подключать для работы с SSI. Примеры использования смотрите в `ssi_examples.php`.

### Языковые файлы

В 3.0 Alpha 2 языковые файлы перемещены в корневую директорию `Languages`, в которой каждый язык хранится в отдельной директории. Например, английский — в `en_US`. Прежнее размещение — `Themes/default/languages` — **пока** оставлено для совместимости. То есть языковые файлы модов, расположенных там, будут загружаться, как и раньше. Глобальная переменная `$language` (в 3.0 — `Config::$language`) теперь содержит не название языка `english`, а локаль `en_US` для языка по умолчанию (для других языков, соответственно, их локали). Следовательно, если в вашей модификации использовалась какая-то привязка к языковым переменным (например, заголовки блоков портала на разных языках), вам придётся все эти названия менять в соответствии с картой `Lang::LANG_TO_LOCALE`.

Начиная с 3.0 Alpha 3 загрузка конкретного файла больше не требует использования функции `Lang::load`, а для получения нужной строки не требуется использовать `Lang::$txt`. Теперь всё немного более очевидно:

```php
<?php

Lang::getTxt('admin_boards', file: 'Admin');
```

### Новая тема + иконки

В Alpha 4 должна появиться новая тема по умолчанию, с поддержкой иконок Font Awesome (и да, они в итоге войдут в состав дистрибутива SMF, как когда-то jQuery) и тёмного режима. Это наверняка потребует адаптации используемых шаблонов.

{{ img('Вот как будет выглядеть страница темы', 'new_theme_preview1.png') }}
{{ img('А вот как будет выглядеть админка', 'new_theme_preview2.png') }}

### Плюрализация

В Alpha 2 добавлена поддержка [ICU MessageFormat](https://habr.com/ru/articles/740788/) для правильной локализации. После этого можно будет наконец без проблем переводить фразы с учётом количества, пола и т. п. в зависимости от текущей локали. Для всего этого предусмотрен новый статический метод `Lang::getTxt`. В английском всего две формы — `one` и `other`, а вот для русского, например, нужно будет при переводе добавлять ещё как минимум две: `few` и `many`. Как это будет выглядеть в коде? Примерно так:

```php
<?php

// 1 пользователь (1 user)
echo 1 . ' ' . Lang::getTxt('user_plural', [1]);
// 1 пользователь (1 user)
echo Lang::getTxt('number_of_users', [1]);
// 2 пользователя (2 users)
echo 2 . ' ' . Lang::getTxt('user_plural', [2]);
// 2 пользователя (2 users)
echo Lang::getTxt('number_of_users', [2]);
// 10 пользователей (10 users)
echo 10 . ' ' . Lang::getTxt('user_plural', [10]);
// 10 пользователей (10 users)
echo Lang::getTxt('number_of_users', [10]);
// 1.5 пользователя (1.5 users)
echo 1.5 . ' ' . Lang::getTxt('user_plural', [1.5]);
// 1.5 пользователя (1.5 users)
echo Lang::getTxt('number_of_users', [1.5]);
```

А в языковых файлах так:

{% raw %}
```php
<?php

// en_US
$txt['user_plural'] = '{0, plural,
  one {user}
  other {users}
}';
$txt['number_of_users'] = '{0, plural,
  one {# user}
  other {# users}
}';

// ru_RU
$txt['user_plural'] = '{0, plural,
  one {пользователь}
  few {пользователя}
  many {пользователей}
  other {пользователя}
}';
$txt['number_of_users'] = '{0, plural,
  one {# пользователь}
  few {# пользователя}
  many {# пользователей}
  other {# пользователя}
}';
```
{% endraw %}

| Категория |       Охватываемые числа        |
| --------- | :-----------------------------: |
| one       |        1, 21, 31, 101, …        |
| few       |         2, 3, 4, 22, …          |
| many      |        5, 6, 27, 108, …         |
| other     | 0.0-1.5, 10.0, 100.0, 1000.0, … |

Где вы видели _полтора пользователя_? Или это когда пользователя зарегистрировали через админку, но он так и не зашёл на форум? Нет, всё равно будет отображаться целое число.

Поэтому в русском языке, если заранее известно, что исходные числа не будут дробными, можно использовать только `other`, а `many` опустить:

{% raw %}
```php
<?php

$txt['number_of_users'] = '{0, plural,
  one {# пользователь}
  few {# пользователя}
  other {# пользователей}
}';
```
{% endraw %}

Для типа `select` нужно указывать возможные варианты и обязательный `other`, используемый, когда ни один вариант не подходит:

{% raw %}
```php
<?php

// Строчка в языковом файле
$txt['some_var'] = '{gender, select,
  =male {Играл}
  =female {Играла}
  other {Играли}
} недавно';

// Использование (в файле внутри Sources или Themes)
echo Lang::getTxt('some_var', ['gender' => 'male']);
```
{% endraw %}

В итоге имеем улучшенный `sprintf`, когда в строчках можно указывать ключевые слова вместо `%s`, `%d`:

{% raw %}
```php
<?php

// Вариант с sprintf
$txt['other_var'] = '%s, у вас непрочитанных сообщений: %d';

echo sprintf(Lang::$txt['other_var'], User::$info['name'], 10);

// Вариант с ICU MessageFormat
$txt['other_var'] = '{username}, у вас {messages, plural,
  one {# непрочитанное сообщение}
  few {# непрочитанных сообщения}
  other {# непрочитанных сообщений}
}';

echo Lang::getTxt('other_var', [
  'username' => User::$info['name'],
  'messages' => 10
]);
```
{% endraw %}

### Markdown

Неожиданно, но факт — уже добавлена [поддержка парсинга Markdown](https://github.com/SimpleMachines/SMF/pull/8349) повсюду на форуме. Markdown сейчас в тренде и выглядит намного проще по сравнению с устаревшим BBCode. Да и крутых визуальных редакторов с поддержкой Markdown гораздо больше. В данном случае будет не замена, а дополнение — поддерживаться будут как BBCode, так и Markdown — одновременно. Редактор сообщений останется тот же — SCEditor.

Сравните сами:

BBCode:

```bbcode
[b]Жирный[/b]
```

Markdown:

```markdown
**Жирный**
```

### robots.txt

Уже внедрена фича для автоматического добавления универсальных правил SMF в `robots.txt` — загляните в секцию _Forum => Search Engines => Settings_. Однако отредактировать файл через админку вам не дадут, поэтому [Optimus](/mods/optimus) всё ещё предоставляет более расширенный функционал!

### ЧПУ-адреса

«Красивые» URL-адреса всё-таки появятся «из коробки» и будут выглядеть примерно так:

```
/boards/<zagolovok>-<id>
/topics/<zagolovok>-<id>
```

Чтобы ваши модификации поддерживали встроенный ЧПУ, понадобится реализовать интерфейс [`SMF\Routable`](https://github.com/SimpleMachines/SMF/blob/release-3.0/Sources/Routable.php).

### Спойлер

Среди поддерживаемых из коробки BBCode также появятся [`details` и `spoiler`](https://github.com/SimpleMachines/SMF/pull/8593), обеспечивая обратную совместимость со всеми существующими модификациями. Это произойдёт ориентировочно в Alpha 4, в дополнение к полной переработке BBCode ([объявления тегов переделаны в классы](https://github.com/SimpleMachines/SMF/pull/8580)).

### Поддержка формата `diff`

В качестве альтернативы `.xml`-файлам менеджер пакетов [теперь поддерживает формат `diff`](https://github.com/SimpleMachines/SMF/pull/8620). Это позволит использовать патч-файлы напрямую, без необходимости создавать объемные `modification.xml`, как было раньше:

```xml
<install for="3.0 Alpha 2 - 3.0.99">
  <modification format="diff">test.patch</modification>
</install>
```

## Заключение

Желающие могут присоединиться к проекту, для этого не обязательно быть программистом, инженером или переводчиком. Например, люди с хорошим знанием современного русского языка могут заняться [вычиткой текущего перевода](https://ru.crowdin.com/project/simple-machines-21-beta/ru). А скрупулёзные пользователи могут [присылать информацию о найденных ими багах](https://www.simplemachines.org/community/index.php?board=137.0), или [предлагать новые фичи](https://www.simplemachines.org/community/index.php?board=3.0) для внедрения. Нет смысла сидеть и ворчать, что бесплатный SMF не так хорош, как платный XenForo, если вы сами не готовы ничего сделать для улучшения.

К моменту релиза финальной третьей версии (когда? — _как только так сразу_) могут появиться ещё какие-нибудь нюансы. Эта статья будет дополняться по мере их появления. Время подготовиться у нас есть.
